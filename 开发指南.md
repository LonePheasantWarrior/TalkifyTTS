# Talkify 开发指南

## 目录

1. [项目描述](#项目描述)
2. [技术栈](#技术栈)
3. [项目架构](#项目架构)
4. [配置存储架构](#配置存储架构)
5. [代码规范](#代码规范)
6. [国际化](#国际化)
7. [资源文件](#资源文件)
8. [已实现功能](#已实现功能)
9. [日志与错误处理](#日志与错误处理)

---

## 项目描述

1. 由云端大模型驱动的安卓语音合成应用。
2. 通过接入云提供商的基于 AI 的 TTS 在线服务来实现语音合成功能。
3. 计划允许接入多个云服务商的在线 TTS 服务，实现软件内切换合成引擎。
4. 安卓原生 UI 风格（Material 3 Expressive）。
5. 基于接口的解耦设计，以便后续接入更多语音引擎（TTS 在线服务）。

## 技术栈

本项目采用现代 Android 开发技术栈：

- **语言**：Kotlin
- **UI 框架**：Jetpack Compose + Material 3 Expressive
- **最低 SDK**：30（Android 11）
- **目标 SDK**：36
- **构建工具**：Gradle 8.13 + AGP 8.13.2

## 项目架构

项目采用分层架构设计，实现了清晰的职责分离：

```
app/src/main/java/com/github/lonepheasantwarrior/talkify/
├── MainActivity.kt                    # 应用入口
├── domain/                            # 领域层（业务逻辑核心）
│   ├── model/
│   │   ├── TtsModels.kt               # TTS 引擎领域模型
│   │   ├── EngineConfig.kt            # 引擎配置数据类（apiKey, voiceId）
│   │   ├── ConfigItem.kt              # 配置项数据类
│   │   ├── EngineIds.kt               # 引擎 ID 密封类（类型安全的引擎标识）
│   │   └── TtsEngineRegistry.kt       # 引擎注册表（单一数据源管理模式）
│   └── repository/
│       ├── VoiceRepository.kt         # 声音仓储接口
│       ├── EngineConfigRepository.kt  # 引擎配置仓储接口
│       └── AppConfigRepository.kt     # 应用配置仓储接口（全局配置）
├── infrastructure/                    # 基础设施层（外部服务集成）
│   ├── engine/                        # 引擎特定实现
│   │   └── repo/
│   │       ├── Qwen3TtsVoiceRepository.kt   # 通义千问3语音仓储实现
│   │       └── Qwen3TtsConfigRepository.kt  # 通义千问3配置仓储实现（SharedPreferences）
│   └── app/                           # 应用级全局配置实现
│       └── repo/
│           └── SharedPreferencesAppConfigRepository.kt # 应用配置仓储实现（全局配置，SharedPreferences）
├── service/                           # 服务层（TTS 引擎服务）
│   ├── TalkifyTtsService.kt           # TTS 服务实现（继承 TextToSpeechService）
│   ├── TalkifyTtsDemoService.kt       # TTS 演示服务（语音预览功能）
│   ├── TtsLogger.kt                   # 日志工具类（支持多级别日志）
│   ├── TtsErrorCode.kt                # 错误码定义（10种错误类型）
│   ├── TtsErrorHelper.kt              # 错误处理助手（Toast提示、错误冷却）
│   └── engine/
│       ├── TtsEngineApi.kt            # 引擎抽象接口（含 TtsSynthesisListener、SynthesisParams）
│       ├── AudioConfig.kt             # 引擎音频配置类
│       ├── TtsStreamHandler.kt        # 流式处理接口（可扩展）
│       ├── AbstractTtsEngine.kt       # 引擎抽象基类（含日志工具方法）
│       ├── TtsEngineFactory.kt        # 引擎工厂（线程安全、支持动态注册）
│       └── impl/
│           └── Qwen3TtsEngine.kt      # 通义千问3引擎实现（DashScope SDK 流式合成）
└── ui/                                # 表现层（UI 组件）
    ├── components/
    │   ├── EngineSelector.kt          # 引擎切换控件
    │   ├── VoicePreview.kt            # 语音预览控件
    │   ├── ConfigEditor.kt            # 配置编辑表单
    │   └── ConfigBottomSheet.kt       # 底部设置弹窗
    ├── screens/
    │   └── MainScreen.kt              # 主界面
    └── theme/                         # 主题配置
        ├── Color.kt                   # 颜色定义
        ├── Theme.kt                   # 主题配置
        └── Type.kt                    # 字体排版
```

### 分层架构说明

**领域层（domain）** 包含核心业务模型和接口定义：

| 类/接口 | 类型 | 说明 |
|--------|------|------|
| `TtsEngine` | 数据类 | TTS 引擎基本信息（id, name, provider） |
| `EngineConfig` | 数据类 | 引擎配置（apiKey, voiceId） |
| `ConfigItem` | 数据类 | 配置项（支持密码/语音选择模式） |
| `EngineIds` | 密封类 | 类型安全的引擎 ID 定义 |
| `TtsEngineRegistry` | 单例 | 引擎注册表（可用引擎列表管理） |
| `VoiceRepository` | 接口 | 声音列表获取标准方法 |
| `EngineConfigRepository` | 接口 | 引擎配置存取标准方法 |
| `AppConfigRepository` | 接口 | 全局配置存取标准方法 |

**引擎 ID 设计原则**：
- 直接采用云服务提供商的官方产品标识符
- 示例：`qwen3-tts`（阿里云通义千问3语音合成服务）
- 便于 API 调用对接，减少映射转换

**基础设施层（infrastructure）** 负责外部服务集成和数据获取：

**engine/ 目录 - 引擎特定实现**：
- `Qwen3TtsVoiceRepository`：从资源文件加载声音列表
- `Qwen3TtsConfigRepository`：使用 SharedPreferences 持久化引擎配置
  - 按引擎 ID 隔离存储不同引擎的配置
  - 存储位置：`talkify_engine_configs.xml`

**app/ 目录 - 应用级全局配置实现**：
- `SharedPreferencesAppConfigRepository`：应用配置仓储实现
  - 存储应用级全局配置：selected_engine（用户选择的引擎 ID）
  - 与引擎特定配置分离，不与任何特定 TTS 引擎绑定
  - 存储位置：`talkify_app_config.xml`

**服务层（service）** 负责 TTS 引擎服务集成：

**TtsLogger 日志工具**：
- 提供统一的日志打印功能，支持多级别（d/i/w/e/v）
- 支持 Debug 日志开关控制（Release 版本可禁用）
- 支持延迟求值的日志消息（减少不必要的字符串拼接）
- 线程安全，使用 `@Volatile` 和 `synchronized`

**TtsErrorCode 错误码**：
- 定义 10 种错误类型（ERROR_NO_ENGINE、ERROR_ENGINE_NOT_CONFIGURED 等）
- 提供错误码到用户友好消息的映射
- 提供错误码到 Android TTS 错误码的转换

**TtsErrorHelper 错误处理助手**：
- 提供用户友好的 Toast 错误提示
- 错误冷却机制（3秒内不重复显示相同错误）
- 配置错误建议操作提示

**TalkifyTtsService**：
- 继承 `android.speech.tts.TextToSpeechService`
- 实现系统 TTS 框架与本应用引擎之间的桥梁
- 根据用户选择的引擎 ID 获取对应的合成引擎
- 获取用户配置的引擎设置（API Key、voiceId）
- 通过 `AppConfigRepository` 获取用户选择的引擎 ID
- 通过 `EngineConfigRepository` 获取引擎配置
- 使用 `TtsEngineFactory` 创建对应的引擎实例
- 委托引擎执行实际的语音合成
- 修复弃用 API：使用 `request.charSequenceText?.toString()` 替代 `request.text`
- 提取合成参数：pitch、speechRate、volume、language 封装为 `SynthesisParams`
- **语言参数传递**：从 `request.language` 获取原始语言代码，直接传递给引擎，不做转换
- 完善的空指针检查和异常处理
- 全面的日志记录（初始化、配置检查、合成流程）
- 硬编码提取为常量（采样率、音频格式、声道数）
- **请求队列机制**：使用 `LinkedBlockingQueue` 暂存合成请求，确保请求按顺序处理
- **信号量同步**：使用 `Semaphore` 限制同时只能有1个合成请求，避免触发云服务速率限制
- **区域代码转换**：支持三字母国家代码（如 CHN）和两字母代码（如 CN）的自动转换
- **协程支持**：使用 `CoroutineScope` 和 `SupervisorJob` 管理异步请求处理
- **优雅关闭**：服务销毁时正确停止请求处理器并释放资源
- **非阻塞轮询**：使用 `poll(100ms)` 替代 `take()`，避免停止时阻塞
- **队列清理**：新请求到达时自动清空旧队列，停止时清理残留请求
- **信号量保护**：停止时检查并释放被占用的信号量，防止死锁

**service/engine/ 目录 - 引擎抽象层**：
- `TtsEngineApi`：引擎抽象接口，定义引擎必须实现的核心方法
  - `synthesize()`：合成语音（支持 SynthesisParams 参数）
  - `stop()`：停止合成
  - `release()`：释放资源
  - `SynthesisParams`：合成参数数据类（pitch、speechRate、volume、language）
- `TtsSynthesisListener`：合成监听器接口（定义于 TtsEngineApi.kt）
  - `onSynthesisStarted()`：合成开始回调
  - `onAudioAvailable()`：音频数据可用（流式传输）
  - `onSynthesisCompleted()`：合成完成回调
  - `onError()`：错误回调
- `AudioConfig`：引擎音频配置类
  - 封装引擎特定的音频参数（采样率、音频格式、声道数）
  - 提供默认配置和引擎特定配置
  - `AudioConfig.QWEN3_TTS`：通义千问3默认配置（24000Hz、PCM_16BIT、单声道）
- `TtsStreamHandler`：流式处理接口（可扩展）
- `AbstractTtsEngine`：引擎抽象基类，提供共性功能的默认实现
  - `isConfigured()`：检查引擎是否已配置（检查 API Key）
  - `stop()`：停止合成（空实现）
  - `release()`：释放资源，设置释放标志
  - `checkNotReleased()`：检查引擎是否已释放，未释放则抛异常
  - 日志工具方法：`logDebug()`、`logInfo()`、`logWarning()`、`logError()`
- `TtsEngineFactory`：引擎工厂，根据引擎 ID 创建对应的引擎实例
  - 线程安全：双重检查锁定的单例模式
  - 支持引擎热插拔，新增引擎只需在此注册
  - `createEngine(id)`：根据 ID 创建引擎实例
  - `isRegistered(id)`：检查引擎是否已注册
  - `getAllEngineInfo()`：获取所有注册引擎信息
  - `registerEngine()`、`unregisterEngine()`：动态注册/注销引擎（用于测试）

**service/engine/impl/ 目录 - 引擎具体实现**：
- `Qwen3TtsEngine`：通义千问3引擎实现
  - 继承 `AbstractTtsEngine`
  - 实现 DashScope SDK 流式语音合成
  - 引擎 ID：`qwen3-tts`
  - **动态声音选择**：使用 `parseVoice()` 方法将用户配置的声音 ID 转换为 `AudioParameters.Voice` 枚举
  - 支持三字母/两字母声音 ID 格式的自动转换（如 "Serena" → `SERENA`）
  - 使用 `MultiModalConversation` 进行流式 API 调用
  - 支持 RxJava Flowable 处理流式响应
  - 音频数据 Base64 解码和回调
  - **智能文本分割**：将长文本按语义和标点分割为小 chunk
    - 优先级 1：句末标点（`。！？.!?`）
    - 优先级 2：句中停顿（`，、,;:：`）
    - 优先级 3：空格、换行符
    - 优先级 4：按长度强制截断（MAX_TEXT_LENGTH = 550）
  - **多 chunk 顺序处理**：单个 chunk 完成后自动处理下一个
  - **流式回调**：首个 chunk 开始时触发 `onSynthesisStarted()`
  - **正确完成通知**：所有 chunk 完成后才触发 `onSynthesisCompleted()`
  - **引擎特定语言转换**：`convertToQwenLanguageType()` 将 ISO 639 语言代码转换为通义千问 API 格式
    - 支持多种 ISO 639 代码格式（zh/zho/chi → Chinese, en/eng → English 等）
    - 无法识别的语言回退到默认 "Chinese"

**表现层（ui）** 负责用户界面呈现和交互：

| 组件 | 功能 |
|------|------|
| `EngineSelector` | 引擎切换，显示当前引擎并支持选择 |
| `VoicePreview` | 语音预览（文本输入、声音选择、播放控制） |
| `ConfigEditor` | 配置编辑表单（API Key、语音选择） |
| `ConfigBottomSheet` | 底部设置弹窗 |
| `MainScreen` | 主界面，整合所有组件 |

## 配置存储架构

### 设计原则：分离全局配置与引擎特定配置

项目将配置分为两类，确保职责清晰：

| 配置类型 | 仓储接口 | 存储内容 | 存储文件 |
|---------|---------|---------|---------|
| 全局配置 | `AppConfigRepository` | 当前选择的引擎 | `talkify_app_config.xml` |
| 引擎配置 | `EngineConfigRepository` | apiKey、voiceId | `talkify_engine_configs.xml` |

### 为什么需要分离？

**问题场景**：如果"选择的引擎"存储在特定引擎的配置中
- ❌ 引擎配置仓储持有全局状态，职责不清
- ❌ 新引擎命名可能造成混淆
- ❌ 架构上不符合单一职责原则

**解决方案**：独立的全局配置仓储
- ✅ `AppConfigRepository` 专门管理全局状态
- ✅ `EngineConfigRepository` 只管引擎特定配置
- ✅ 新增引擎时，不会影响全局配置逻辑

### 引擎选择持久化流程

```
应用启动 → AppConfigRepository.getSelectedEngineId()
         ↓
    存在已保存ID → TtsEngineRegistry.getEngine() 获取引擎
         ↓ 不存在
    保存默认引擎ID → 使用默认引擎
```

## 代码规范

### KDoc 注释标准

项目要求所有公开 API 和关键组件添加 KDoc 注释，确保代码自文档化：

**接口类注释**：
```kotlin
/**
 * 引擎配置仓储接口
 *
 * 定义引擎配置存取的标准方法
 * 采用接口设计，解耦配置存储与业务逻辑
 * 支持多引擎配置隔离存储
 */
interface EngineConfigRepository
```

**数据类注释**：
```kotlin
/**
 * 配置项数据类
 *
 * @param key 配置项唯一标识
 * @param label 显示标签
 * @param value 当前值
 * @param isPassword 是否为密码输入模式
 * @param isVoiceSelector 是否为语音选择模式
 */
data class ConfigItem(...)
```

### 命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| 仓储实现 | `{引擎名称}VoiceRepository` | `Qwen3TtsVoiceRepository` |
| 仓储实现 | `{引擎名称}ConfigRepository` | `Qwen3TtsConfigRepository` |
| 仓储实现 | `SharedPreferencesAppConfigRepository` | 全局配置仓储 |
| 引擎 ID | 使用云服务官方产品标识符 | `qwen3-tts` |
| 引擎接口 | `{引擎名称}Engine` | `Qwen3TtsEngine` |
| 引擎工厂 | `TtsEngineFactory` | 引擎工厂单例 |
| TTS 服务 | `TalkifyTtsService` | TTS 服务实现 |

**命名原则**：使用具体引擎名称作为类名前缀，避免使用云服务商公司名称
- ✅ 正确：`Qwen3TtsVoiceRepository`
- ❌ 错误：`AlibabaCloudVoiceRepository`（公司名称，不够具体）

## 国际化

项目支持多语言，通过 Android 资源系统实现字符串外部化。

### 字符串资源文件

所有 UI 文本应定义在 `app/src/main/res/values/strings.xml`：

```xml
<!-- 通用 -->
<string name="settings">设置</string>
<string name="save">保存</string>
<string name="cancel">取消</string>

<!-- 主界面 -->
<string name="synthesis_engine">合成引擎</string>
<string name="provider_format">提供商: %1$s</string>

<!-- 语音预览 -->
<string name="voice_preview">语音预览</string>
<string name="input_text_label">输入要合成的文本</string>
<string name="play">播放</string>
<string name="stop">停止</string>

<!-- 配置编辑 -->
<string name="api_key_label">API Key</string>
<string name="save_config">保存配置</string>
```

### 添加新字符串的流程

1. 在 `strings.xml` 中添加新的字符串资源
2. 在 UI 组件中使用 `stringResource(R.string.字符串_id)` 引用
3. 添加其他语言版本（values-zh-rCN、values-en 等）

### 使用示例

```kotlin
@Composable
fun ExampleComponent() {
    Text(
        text = stringResource(R.string.settings),
        style = MaterialTheme.typography.titleMedium
    )
}
```

### Composable 上下文字符串使用

在 `remember` 或状态初始化块中使用字符串时，需先获取字符串：

```kotlin
// 正确：先获取字符串
@Composable
fun ExampleComponent() {
    val title = stringResource(R.string.title)
    var text by remember { mutableStateOf(title) }
    // ...
}

// 错误：Composable 调用不在 Composable 上下文中
@Composable
fun ExampleComponent() {
    var text by remember { mutableStateOf(stringResource(R.string.title)) } // 编译错误！
    // ...
}
```

### TTS 错误消息

TTS 服务使用统一的错误码体系，定义在 `TtsErrorCode`：

| 错误码 | 错误消息 |
|--------|----------|
| ERROR_NO_ENGINE | 未找到可用的 TTS 引擎 |
| ERROR_ENGINE_NOT_FOUND | 引擎不存在 |
| ERROR_ENGINE_NOT_CONFIGURED | 请先配置 API Key |
| ERROR_SYNTHESIS_FAILED | 语音合成失败 |
| ERROR_NETWORK_UNAVAILABLE | 网络不可用，请检查网络连接 |
| ERROR_INVALID_REQUEST | 无效的合成请求 |
| ERROR_ENGINE_INIT_FAILED | 引擎初始化失败 |
| ERROR_CONFIG_NOT_FOUND | 未找到引擎配置 |
| ERROR_UNKNOWN | 发生未知错误 |
| ERROR_NOT_IMPLEMENTED | 该引擎功能尚未实现 |

**用户提示配置建议**：`tts_config_suggestion` - "请前往应用设置页面配置 API Key"

**错误处理助手**：`TtsErrorHelper` 提供用户友好的 Toast 提示，包含 3 秒冷却机制避免重复提示。

## 资源文件

- `app/src/main/res/values/strings.xml`：UI 字符串资源（支持国际化）
- `app/src/main/res/values/bailian-Qwen3-TTS-voices.xml`：阿里云通义千问3引擎的声音配置
  - voice_ids：声音英文标识
  - display_names：中文显示名称
  - descriptions：声音特色描述
  - supported_languages：支持语言
  - supported_models：支持的模型版本
- `app/src/main/res/xml/tts_service_meta_data.xml`：TTS 服务元数据
  - 声明支持的语音语言（zh、en）
  - 系统通过此文件识别 TTS 引擎

### 声音配置 XML 结构示例

```xml
<resources>
    <voice>
        <voice_id>aitianhuaxiao</voice_id>
        <display_name>艾天华小</display_name>
        <description>童声，活泼可爱</description>
        <supported_languages>zh</supported_languages>
        <supported_models>qwen3-tts</supported_models>
    </voice>
    <!-- 更多声音配置... -->
</resources>
```

## 已实现功能

### 1. 引擎切换功能

- 显示当前选中的 TTS 引擎信息（名称和提供商）
- 点击弹出 Material 3 底部选择 Sheet
- 支持 SegmentedButton 风格的引擎选择
- 当前默认引擎：阿里云百炼"通义千问3语音合成"

### 2. 语音预览功能

**文本输入区域**：
- 多行文本输入框（3-5 行）
- 支持自定义标签和占位符
- 默认文本示例："你好，这是语音合成的测试文本。"

**声音选择区域**：
- 水平滚动列表展示可选声音
- 每个声音显示中文友好名称
- 选中状态有视觉反馈（高亮背景）
- 支持 48 种阿里云通义千问3引擎的声音
- 无可用声音时显示空状态提示

**播放控制区域**：
- 长条形 Pill Button 样式
- 播放状态：绿色主题，显示"播放"文字和播放图标
- 停止状态：红色主题，显示"停止"文字和停止图标
- 图标和文字并排显示，不再残缺

### 3. 动态声音加载

- 使用 `LaunchedEffect` 监听引擎变化
- 根据当前引擎动态加载对应的声音列表
- 自动选中保存的配置中指定的声音或第一个可用声音
- 加载过程中显示加载动画
- 接口设计便于后续扩展其他引擎服务

### 4. 引擎配置编辑与存储

**配置编辑**：
- 右下角悬浮按钮（FloatingActionButton）唤出底部设置弹窗
- API Key 输入框（密码模式隐藏输入）
- 声音选择下拉菜单（从引擎可用声音列表中选择）
- 修改状态追踪，仅在有修改时启用保存按钮
- 保存后自动关闭设置弹窗

**配置存储**：
- 引擎特定配置：使用 `EngineConfigRepository` 存储
  - 存储位置：`talkify_engine_configs.xml`
  - 配置内容：apiKey（API 密钥）、voiceId（默认声音 ID）
  - 按引擎 ID 隔离存储
  - 支持冷启动恢复
- 引擎选择：使用 `AppConfigRepository` 存储
  - 存储位置：`talkify_app_config.xml`
  - 配置内容：selected_engine（用户选择的引擎 ID）
  - 全局配置，独立于任何引擎

**交互优化**：
- 底部弹窗设计，比侧边抽屉更适合移动端
- 右下角悬浮按钮提供清晰的设置入口
- 点击外部区域或关闭按钮可关闭弹窗
- 保存成功后自动关闭

### 5. 引擎注册表

项目使用统一的引擎注册表管理所有可用引擎：

**注册表功能**：
- `TtsEngineRegistry.availableEngines`：获取所有可用引擎列表
- `TtsEngineRegistry.getEngine(id)`：根据 ID 获取引擎
- `TtsEngineRegistry.defaultEngine`：获取默认引擎
- `EngineIds.entries`：获取所有定义的引擎 ID

**新增引擎步骤**：
1. 在 `EngineIds` 密封类中添加新的引擎 ID 定义
2. 创建对应的 Repository 实现
3. 在对应的 Repository 实现中添加引擎特定逻辑
4. 在 `MainScreen` 中注入对应的 Repository 实现
5. 注册表自动识别新引擎，无需额外配置

### 6. 国际化支持

- 所有 UI 文本外部化到 `strings.xml`
- 支持中文（默认）和英文（可扩展）
- 统一的字符串使用规范
- 良好的空状态和加载状态处理

### 7. TTS 服务注册

**服务声明**：
- 在 `AndroidManifest.xml` 中声明 `TalkifyTtsService`
- 使用 `android.permission.BIND_TEXT_TO_SPEECH_SERVICE` 权限
- 通过 `android.intent.action.TTS_SERVICE` intent-filter 注册
- 提供 TTS 服务元数据 `tts_service_meta_data.xml`

**元数据配置**：
- `app/src/main/res/xml/tts_service_meta_data.xml`
- 声明支持的语音语言（zh、en）

**引擎抽象层**：
- `TtsEngineApi` 接口定义引擎核心方法
- `AbstractTtsEngine` 提供共性功能默认实现
- `TtsEngineFactory` 工厂支持引擎热插拔
- 引擎实例持有配置（API Key、voiceId）

**服务启动流程**：
1. 系统调用 `onCreate()` 初始化
2. 通过 `AppConfigRepository` 获取用户选择的引擎 ID
3. 通过 `EngineConfigRepository` 获取引擎配置
4. 使用 `TtsEngineFactory` 创建对应的引擎实例
5. 收到合成请求时委托引擎执行实际合成

### 8. 日志与错误处理

**日志系统（TtsLogger）**：
- 统一的日志打印工具，支持多级别（Debug/Info/Warning/Error/Verbose）
- Debug 日志可通过 `setDebugEnabled()` 开关控制
- 支持延迟求值的日志消息（减少不必要的字符串拼接）
- 线程安全，使用 `@Volatile` 和 `synchronized`
- 在 Release 构建时可选择性禁用所有日志

**错误码体系（TtsErrorCode）**：
- 定义 10 种统一的错误类型
- 错误码到用户友好消息的映射
- 提供错误码到 Android TTS 错误码的转换（`toAndroidError()`）
- 便于统一处理和国际化

**错误处理助手（TtsErrorHelper）**：
- 提供用户友好的 Toast 错误提示
- 3 秒冷却机制避免重复提示相同错误
- 自动记录错误到日志
- 配置错误时提供操作建议

**TalkifyTtsService 错误处理**：
- 完善的空指针检查和异常处理
- 全面的日志记录（初始化、配置检查、合成流程）
- 硬编码提取为常量（采样率、音频格式、声道数）
- 引擎释放状态追踪，防止重复释放

**引擎抽象层增强**：
- `AbstractTtsEngine` 提供日志工具方法
- `checkNotReleased()` 防止已释放的引擎被使用
- `isConfigured()` 检查引擎是否已配置（API Key）
- `TtsEngineFactory` 线程安全设计

### 9. 流式音频合成引擎实现

**AudioConfig 引擎音频配置类**：
- 封装引擎特定的音频参数
- 支持不同引擎使用不同的采样率和音频格式
- 提供默认配置和引擎特定配置
- 示例配置：
  - 通义千问3 TTS：采样率 24000Hz、PCM_16BIT、单声道

**SynthesisParams 合成参数数据类**：
- 封装语音合成的可调参数
- `pitch`：音调，值域 [0.0, 2.0]
- `speechRate`：语速，值域 [0.0, 2.0]
- `volume`：音量，值域 [0.0, 1.0]
- `language`：原始语言代码（ISO 639），由调用方从 `SynthesisRequest` 提取
- 从 `SynthesisRequest` 提取参数传递给引擎
- **语言参数设计**：保留原始 ISO 639 代码，不做转换，由各引擎实现自己的转换逻辑

**Qwen3TtsEngine 通义千问3引擎完整实现**：
- 基于 DashScope SDK 的流式音频合成
- 北京地域 API 端点：`https://dashscope.aliyuncs.com/api/v1`
- 使用 `MultiModalConversation.streamCall()` 实现流式合成
- `Flowable<MultiModalConversationResult>` 响应式流处理
- `DisposableSubscriber` 订阅流式结果
- 音频数据提取：`MultiModalConversationResult.getOutput().audio`
- Base64 解码后传递给监听器
- 引擎状态管理：isReleased、isCancelled、hasCompleted
- **智能文本分割**：`splitTextIntoChunks()` 方法将长文本按语义和标点分割
  - 优先级 1：句末标点（`。！？.!?`）适合自然停顿
  - 优先级 2：句中停顿（`，、,;:：`）用于次级分割点
  - 优先级 3：空格、换行符作为备用分割位置
  - 优先级 4：按长度强制截断（MAX_TEXT_LENGTH = 550）
  - 支持中英文、全角半角标点符号
- **多 chunk 顺序处理**：`processNextChunk()` 递归处理多个文本块
  - 单个 chunk 完成后自动调用下一个
  - 首个 chunk 开始时触发 `onSynthesisStarted()`
  - 所有 chunk 完成后触发 `onSynthesisCompleted()`
  - 支持取消和停止操作
- **语言代码转换**：`convertToQwenLanguageType()` 将 ISO 639 代码转换为 API 格式
  - 输入：原始语言代码（zh, zho, chi, en, eng 等）
  - 输出：通义千问 API 语言类型（Chinese, English 等）
  - 不支持的语言回退到默认 "Chinese"
- 完善的错误处理：
  - `NoApiKeyException` → API Key 配置错误
  - `UploadFileException` → 上传文件失败
  - `ApiException` → API 调用失败
  - 其他异常 → 发生错误

**TtsSynthesisListener 合成监听器接口**：
- `onSynthesisStarted()`：合成开始回调
- `onAudioAvailable()`：音频数据可用（流式传输）
- `onSynthesisCompleted()`：合成完成回调
- `onError()`：错误回调

**TtsStreamHandler 流式处理接口**：
- 定义流式音频处理的标准方法
- 支持扩展不同类型的流处理实现

### 10. 语音预览功能（DemoService）

**TalkifyTtsDemoService 独立 TTS 演示服务**：
- 用于语音预览功能的独立服务，不依赖 Android TTS 系统框架
- 调用用户选择的 TTS 引擎进行语音合成
- 使用 `AudioTrack` 本地播放流式音频
- 支持播放、停止、释放操作

**服务状态管理**：
- `STATE_IDLE`：空闲状态
- `STATE_PLAYING`：播放中
- `STATE_STOPPED`：已停止
- `STATE_ERROR`：错误状态
- 状态监听器回调：`setStateListener(listener)`

**AudioTrack 配置**：
- 播放模式：`MODE_STREAM`（流式播放）
- 音频属性：`USAGE_MEDIA`、`CONTENT_TYPE_SPEECH`
- 动态缓冲区大小调整
- 单声道/立体声自动适配

**配置实时更新机制**：
- `ConfigBottomSheet` 添加 `onConfigSaved` 回调参数
- 用户点击"保存配置"后立即通知调用方
- `MainScreen` 接收回调并重新加载配置
- 解决配置缓存问题，无需重启应用即可使用新配置

**使用流程**：
```
用户输入文本 → 选择音色 → 点击播放
    ↓
验证输入和配置
    ↓
demoService.speak(text, config, params)
    ↓
TtsEngineFactory 创建引擎
    ↓
引擎流式合成音频
    ↓
AudioTrack 实时播放
    ↓
播放完成/停止
```

### 11. 请求队列与速率控制

**问题背景**：
- 第三方 TTS 云服务通常有速率限制（RPS/RPM）
- Android TTS 框架可能在短时间内发送大量请求
- 直接处理会导致 "Requests rate limit exceeded" 错误

**请求队列机制**：
- 使用 `LinkedBlockingQueue<SynthesisRequestWrapper>` 暂存合成请求
- `onSynthesizeText()` 将请求加入队列后立即返回，不阻塞调用线程
- 后台处理器按顺序取出请求进行处理
- **非阻塞轮询**：使用 `poll(100ms)` 替代阻塞式 `take()`，避免停止时死锁
- **队列清理**：新请求到达时自动清空 `requestQueue`，确保只处理最新请求

**信号量同步**：
- 使用 `Semaphore(1)` 限制同时只能有1个合成请求
- 处理请求前获取信号量 `processingSemaphore.acquire()`
- 完成或错误时释放信号量 `processingSemaphore.release()`
- 确保请求按顺序处理，避免触发速率限制
- **信号量保护**：停止时检查 `availablePermits()`，未释放时强制释放

**协程支持**：
- 使用 `CoroutineScope(SupervisorJob() + Dispatchers.IO)` 管理异步任务
- 请求处理器在协程中运行，不会阻塞主线程
- 服务销毁时取消协程 `serviceScope.cancel()`

**优雅关闭**：
- 使用 `AtomicBoolean(isStopped)` 标记服务状态
- 服务销毁时设置停止标志
- 正在处理的请求完成后自动退出处理循环
- 清理引擎资源和信号量
- **停止回调**：`onStop()` 调用时清理队列并释放信号量
- **处理前检查**：`processRequestInternal()` 处理前检查 `isStopped` 状态

**工作流程**：
```
用户按下停止 → onStop() → 清空队列 + 释放信号量
    ↓
用户再次开始 → onSynthesizeText() → 清空旧队列 → 加入新请求
    ↓
后台处理器循环：
    - poll(100ms) 非阻塞获取请求
    - 检查服务状态 isStopped
    - 获取 processingSemaphore
    - 执行语音合成
    - 完成/错误时释放信号量
    ↓
处理下一个请求
```

**配置隔离**：
- 按引擎 ID 隔离存储不同引擎的配置
- API Key、voiceId 等敏感信息独立存储
- 防止配置混淆和数据泄露
