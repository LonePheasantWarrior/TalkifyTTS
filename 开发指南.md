# Talkify 开发指南

## 目录

1. [项目描述](#项目描述)
2. [技术栈](#技术栈)
3. [项目架构](#项目架构)
4. [配置存储架构](#配置存储架构)
5. [代码规范](#代码规范)
6. [国际化](#国际化)
7. [资源文件](#资源文件)
8. [已实现功能](#已实现功能)

---

## 项目描述

1. 由云端大模型驱动的安卓语音合成应用。
2. 通过接入云提供商的基于 AI 的 TTS 在线服务来实现语音合成功能。
3. 计划允许接入多个云服务商的在线 TTS 服务，实现软件内切换合成引擎。
4. 安卓原生 UI 风格（Material 3 Expressive）。
5. 基于接口的解耦设计，以便后续接入更多语音引擎（TTS 在线服务）。

## 技术栈

本项目采用现代 Android 开发技术栈：

- **语言**：Kotlin
- **UI 框架**：Jetpack Compose + Material 3 Expressive
- **最低 SDK**：30（Android 11）
- **目标 SDK**：36
- **构建工具**：Gradle 8.13 + AGP 8.13.2

## 项目架构

项目采用分层架构设计，实现了清晰的职责分离：

```
app/src/main/java/com/github/lonepheasantwarrior/talkify/
├── MainActivity.kt                    # 应用入口
├── domain/                            # 领域层（业务逻辑核心）
│   ├── model/
│   │   ├── TtsModels.kt               # TTS 引擎领域模型
│   │   ├── EngineConfig.kt            # 引擎配置数据类（apiKey, voiceId）
│   │   ├── ConfigItem.kt              # 配置项数据类
│   │   ├── EngineIds.kt               # 引擎 ID 密封类（类型安全的引擎标识）
│   │   └── TtsEngineRegistry.kt       # 引擎注册表（单一数据源管理模式）
│   └── repository/
│       ├── VoiceRepository.kt         # 声音仓储接口
│       ├── EngineConfigRepository.kt  # 引擎配置仓储接口
│       └── AppConfigRepository.kt     # 应用配置仓储接口（全局配置）
├── infrastructure/                    # 基础设施层（外部服务集成）
│   ├── engine/                        # 引擎特定实现
│   │   └── repo/
│   │       ├── Qwen3TtsVoiceRepository.kt   # 通义千问3语音仓储实现
│   │       └── Qwen3TtsConfigRepository.kt  # 通义千问3配置仓储实现（SharedPreferences）
│   └── app/                           # 应用级全局配置实现
│       └── repo/
│           └── SharedPreferencesAppConfigRepository.kt # 应用配置仓储实现（全局配置，SharedPreferences）
├── service/                           # 服务层（TTS 引擎服务）
│   ├── TalkifyTtsService.kt           # TTS 服务实现（继承 TextToSpeechService）
│   └── engine/
│       ├── TtsEngineApi.kt            # 引擎抽象接口
│       ├── AbstractTtsEngine.kt       # 引擎抽象基类
│       ├── TtsEngineFactory.kt        # 引擎工厂（单例）
│       └── impl/
│           └── Qwen3TtsEngine.kt      # 通义千问3引擎实现（空实现，待后续开发）
└── ui/                                # 表现层（UI 组件）
    ├── components/
    │   ├── EngineSelector.kt          # 引擎切换控件
    │   ├── VoicePreview.kt            # 语音预览控件
    │   ├── ConfigEditor.kt            # 配置编辑表单
    │   └── ConfigBottomSheet.kt       # 底部设置弹窗
    ├── screens/
    │   └── MainScreen.kt              # 主界面
    └── theme/                         # 主题配置
        ├── Color.kt                   # 颜色定义
        ├── Theme.kt                   # 主题配置
        └── Type.kt                    # 字体排版
```

### 分层架构说明

**领域层（domain）** 包含核心业务模型和接口定义：

| 类/接口 | 类型 | 说明 |
|--------|------|------|
| `TtsEngine` | 数据类 | TTS 引擎基本信息（id, name, provider） |
| `EngineConfig` | 数据类 | 引擎配置（apiKey, voiceId） |
| `ConfigItem` | 数据类 | 配置项（支持密码/语音选择模式） |
| `EngineIds` | 密封类 | 类型安全的引擎 ID 定义 |
| `TtsEngineRegistry` | 单例 | 引擎注册表（可用引擎列表管理） |
| `VoiceRepository` | 接口 | 声音列表获取标准方法 |
| `EngineConfigRepository` | 接口 | 引擎配置存取标准方法 |
| `AppConfigRepository` | 接口 | 全局配置存取标准方法 |

**引擎 ID 设计原则**：
- 直接采用云服务提供商的官方产品标识符
- 示例：`qwen3-tts`（阿里云通义千问3语音合成服务）
- 便于 API 调用对接，减少映射转换

**基础设施层（infrastructure）** 负责外部服务集成和数据获取：

**engine/ 目录 - 引擎特定实现**：
- `Qwen3TtsVoiceRepository`：从资源文件加载声音列表
- `Qwen3TtsConfigRepository`：使用 SharedPreferences 持久化引擎配置
  - 按引擎 ID 隔离存储不同引擎的配置
  - 存储位置：`talkify_engine_configs.xml`

**app/ 目录 - 应用级全局配置实现**：
- `SharedPreferencesAppConfigRepository`：应用配置仓储实现
  - 存储应用级全局配置：selected_engine（用户选择的引擎 ID）
  - 与引擎特定配置分离，不与任何特定 TTS 引擎绑定
  - 存储位置：`talkify_app_config.xml`

**服务层（service）** 负责 TTS 引擎服务集成：

**TalkifyTtsService**：
- 继承 `android.speech.tts.TextToSpeechService`
- 实现系统 TTS 框架与本应用引擎之间的桥梁
- 根据用户选择的引擎 ID 获取对应的合成引擎
- 获取用户配置的引擎设置（API Key、voiceId）
- 通过 `AppConfigRepository` 获取用户选择的引擎 ID
- 通过 `EngineConfigRepository` 获取引擎配置
- 使用 `TtsEngineFactory` 创建对应的引擎实例
- 委托引擎执行实际的语音合成

**service/engine/ 目录 - 引擎抽象层**：
- `TtsEngineApi`：引擎抽象接口，定义引擎必须实现的核心方法
  - `synthesize()`：合成语音
  - `stop()`：停止合成
  - `release()`：释放资源
- `AbstractTtsEngine`：引擎抽象基类，提供共性功能的默认实现
- `TtsEngineFactory`：引擎工厂，根据引擎 ID 创建对应的引擎实例
  - 支持引擎热插拔，新增引擎只需在工厂中注册
  - `createEngine(id)`：根据 ID 创建引擎实例
  - `isRegistered(id)`：检查引擎是否已注册

**service/engine/impl/ 目录 - 引擎具体实现**：
- `Qwen3TtsEngine`：通义千问3引擎实现
  - 继承 `AbstractTtsEngine`
  - 目前为占位实现，语音合成功能待后续开发
  - 引擎 ID：`qwen3-tts`

**表现层（ui）** 负责用户界面呈现和交互：

| 组件 | 功能 |
|------|------|
| `EngineSelector` | 引擎切换，显示当前引擎并支持选择 |
| `VoicePreview` | 语音预览（文本输入、声音选择、播放控制） |
| `ConfigEditor` | 配置编辑表单（API Key、语音选择） |
| `ConfigBottomSheet` | 底部设置弹窗 |
| `MainScreen` | 主界面，整合所有组件 |

## 配置存储架构

### 设计原则：分离全局配置与引擎特定配置

项目将配置分为两类，确保职责清晰：

| 配置类型 | 仓储接口 | 存储内容 | 存储文件 |
|---------|---------|---------|---------|
| 全局配置 | `AppConfigRepository` | 当前选择的引擎 | `talkify_app_config.xml` |
| 引擎配置 | `EngineConfigRepository` | apiKey、voiceId | `talkify_engine_configs.xml` |

### 为什么需要分离？

**问题场景**：如果"选择的引擎"存储在特定引擎的配置中
- ❌ 引擎配置仓储持有全局状态，职责不清
- ❌ 新引擎命名可能造成混淆
- ❌ 架构上不符合单一职责原则

**解决方案**：独立的全局配置仓储
- ✅ `AppConfigRepository` 专门管理全局状态
- ✅ `EngineConfigRepository` 只管引擎特定配置
- ✅ 新增引擎时，不会影响全局配置逻辑

### 引擎选择持久化流程

```
应用启动 → AppConfigRepository.getSelectedEngineId()
         ↓
    存在已保存ID → TtsEngineRegistry.getEngine() 获取引擎
         ↓ 不存在
    保存默认引擎ID → 使用默认引擎
```

## 代码规范

### KDoc 注释标准

项目要求所有公开 API 和关键组件添加 KDoc 注释，确保代码自文档化：

**接口类注释**：
```kotlin
/**
 * 引擎配置仓储接口
 *
 * 定义引擎配置存取的标准方法
 * 采用接口设计，解耦配置存储与业务逻辑
 * 支持多引擎配置隔离存储
 */
interface EngineConfigRepository
```

**数据类注释**：
```kotlin
/**
 * 配置项数据类
 *
 * @param key 配置项唯一标识
 * @param label 显示标签
 * @param value 当前值
 * @param isPassword 是否为密码输入模式
 * @param isVoiceSelector 是否为语音选择模式
 */
data class ConfigItem(...)
```

### 命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| 仓储实现 | `{引擎名称}VoiceRepository` | `Qwen3TtsVoiceRepository` |
| 仓储实现 | `{引擎名称}ConfigRepository` | `Qwen3TtsConfigRepository` |
| 仓储实现 | `SharedPreferencesAppConfigRepository` | 全局配置仓储 |
| 引擎 ID | 使用云服务官方产品标识符 | `qwen3-tts` |
| 引擎接口 | `{引擎名称}Engine` | `Qwen3TtsEngine` |
| 引擎工厂 | `TtsEngineFactory` | 引擎工厂单例 |
| TTS 服务 | `TalkifyTtsService` | TTS 服务实现 |

**命名原则**：使用具体引擎名称作为类名前缀，避免使用云服务商公司名称
- ✅ 正确：`Qwen3TtsVoiceRepository`
- ❌ 错误：`AlibabaCloudVoiceRepository`（公司名称，不够具体）

## 国际化

项目支持多语言，通过 Android 资源系统实现字符串外部化。

### 字符串资源文件

所有 UI 文本应定义在 `app/src/main/res/values/strings.xml`：

```xml
<!-- 通用 -->
<string name="settings">设置</string>
<string name="save">保存</string>
<string name="cancel">取消</string>

<!-- 主界面 -->
<string name="synthesis_engine">合成引擎</string>
<string name="provider_format">提供商: %1$s</string>

<!-- 语音预览 -->
<string name="voice_preview">语音预览</string>
<string name="input_text_label">输入要合成的文本</string>
<string name="play">播放</string>
<string name="stop">停止</string>

<!-- 配置编辑 -->
<string name="api_key_label">API Key</string>
<string name="save_config">保存配置</string>
```

### 添加新字符串的流程

1. 在 `strings.xml` 中添加新的字符串资源
2. 在 UI 组件中使用 `stringResource(R.string.字符串_id)` 引用
3. 添加其他语言版本（values-zh-rCN、values-en 等）

### 使用示例

```kotlin
@Composable
fun ExampleComponent() {
    Text(
        text = stringResource(R.string.settings),
        style = MaterialTheme.typography.titleMedium
    )
}
```

### Composable 上下文字符串使用

在 `remember` 或状态初始化块中使用字符串时，需先获取字符串：

```kotlin
// 正确：先获取字符串
@Composable
fun ExampleComponent() {
    val title = stringResource(R.string.title)
    var text by remember { mutableStateOf(title) }
    // ...
}

// 错误：Composable 调用不在 Composable 上下文中
@Composable
fun ExampleComponent() {
    var text by remember { mutableStateOf(stringResource(R.string.title)) } // 编译错误！
    // ...
}
```

## 资源文件

- `app/src/main/res/values/strings.xml`：UI 字符串资源（支持国际化）
- `app/src/main/res/values/bailian-Qwen3-TTS-voices.xml`：阿里云通义千问3引擎的声音配置
  - voice_ids：声音英文标识
  - display_names：中文显示名称
  - descriptions：声音特色描述
  - supported_languages：支持语言
  - supported_models：支持的模型版本
- `app/src/main/res/xml/tts_service_meta_data.xml`：TTS 服务元数据
  - 声明支持的语音语言（zh、en）
  - 系统通过此文件识别 TTS 引擎

### 声音配置 XML 结构示例

```xml
<resources>
    <voice>
        <voice_id>aitianhuaxiao</voice_id>
        <display_name>艾天华小</display_name>
        <description>童声，活泼可爱</description>
        <supported_languages>zh</supported_languages>
        <supported_models>qwen3-tts</supported_models>
    </voice>
    <!-- 更多声音配置... -->
</resources>
```

## 已实现功能

### 1. 引擎切换功能

- 显示当前选中的 TTS 引擎信息（名称和提供商）
- 点击弹出 Material 3 底部选择 Sheet
- 支持 SegmentedButton 风格的引擎选择
- 当前默认引擎：阿里云百炼"通义千问3语音合成"

### 2. 语音预览功能

**文本输入区域**：
- 多行文本输入框（3-5 行）
- 支持自定义标签和占位符
- 默认文本示例："你好，这是语音合成的测试文本。"

**声音选择区域**：
- 水平滚动列表展示可选声音
- 每个声音显示中文友好名称
- 选中状态有视觉反馈（高亮背景）
- 支持 48 种阿里云通义千问3引擎的声音
- 无可用声音时显示空状态提示

**播放控制区域**：
- 长条形 Pill Button 样式
- 播放状态：绿色主题，显示"播放"文字和播放图标
- 停止状态：红色主题，显示"停止"文字和停止图标
- 图标和文字并排显示，不再残缺

### 3. 动态声音加载

- 使用 `LaunchedEffect` 监听引擎变化
- 根据当前引擎动态加载对应的声音列表
- 自动选中保存的配置中指定的声音或第一个可用声音
- 加载过程中显示加载动画
- 接口设计便于后续扩展其他引擎服务

### 4. 引擎配置编辑与存储

**配置编辑**：
- 右下角悬浮按钮（FloatingActionButton）唤出底部设置弹窗
- API Key 输入框（密码模式隐藏输入）
- 声音选择下拉菜单（从引擎可用声音列表中选择）
- 修改状态追踪，仅在有修改时启用保存按钮
- 保存后自动关闭设置弹窗

**配置存储**：
- 引擎特定配置：使用 `EngineConfigRepository` 存储
  - 存储位置：`talkify_engine_configs.xml`
  - 配置内容：apiKey（API 密钥）、voiceId（默认声音 ID）
  - 按引擎 ID 隔离存储
  - 支持冷启动恢复
- 引擎选择：使用 `AppConfigRepository` 存储
  - 存储位置：`talkify_app_config.xml`
  - 配置内容：selected_engine（用户选择的引擎 ID）
  - 全局配置，独立于任何引擎

**交互优化**：
- 底部弹窗设计，比侧边抽屉更适合移动端
- 右下角悬浮按钮提供清晰的设置入口
- 点击外部区域或关闭按钮可关闭弹窗
- 保存成功后自动关闭

### 5. 引擎注册表

项目使用统一的引擎注册表管理所有可用引擎：

**注册表功能**：
- `TtsEngineRegistry.availableEngines`：获取所有可用引擎列表
- `TtsEngineRegistry.getEngine(id)`：根据 ID 获取引擎
- `TtsEngineRegistry.defaultEngine`：获取默认引擎
- `EngineIds.entries`：获取所有定义的引擎 ID

**新增引擎步骤**：
1. 在 `EngineIds` 密封类中添加新的引擎 ID 定义
2. 创建对应的 Repository 实现
3. 在对应的 Repository 实现中添加引擎特定逻辑
4. 在 `MainScreen` 中注入对应的 Repository 实现
5. 注册表自动识别新引擎，无需额外配置

### 6. 国际化支持

- 所有 UI 文本外部化到 `strings.xml`
- 支持中文（默认）和英文（可扩展）
- 统一的字符串使用规范
- 良好的空状态和加载状态处理

### 7. TTS 服务注册

**服务声明**：
- 在 `AndroidManifest.xml` 中声明 `TalkifyTtsService`
- 使用 `android.permission.BIND_TEXT_TO_SPEECH_SERVICE` 权限
- 通过 `android.intent.action.TTS_SERVICE` intent-filter 注册
- 提供 TTS 服务元数据 `tts_service_meta_data.xml`

**元数据配置**：
- `app/src/main/res/xml/tts_service_meta_data.xml`
- 声明支持的语音语言（zh、en）

**引擎抽象层**：
- `TtsEngineApi` 接口定义引擎核心方法
- `AbstractTtsEngine` 提供共性功能默认实现
- `TtsEngineFactory` 工厂支持引擎热插拔
- 引擎实例持有配置（API Key、voiceId）

**服务启动流程**：
1. 系统调用 `onCreate()` 初始化
2. 通过 `AppConfigRepository` 获取用户选择的引擎 ID
3. 通过 `EngineConfigRepository` 获取引擎配置
4. 使用 `TtsEngineFactory` 创建对应的引擎实例
5. 收到合成请求时委托引擎执行实际合成
