## 项目描述

1. 由云端大模型驱动的安卓语音合成应用。
2. 通过接入云提供商的基于 AI 的 TTS 在线服务来实现语音合成功能。
3. 计划允许接入多个云服务商的的在线 TTS 服务，实现软件内切换合成引擎。
4. 安卓原生 UI 风格（Material 3 Expressive）。
5. 基于接口的解耦设计，以便后续接入更多语音引擎（TTS 在线服务）。

## 技术栈

本项目采用现代 Android 开发技术栈：

- **语言**：Kotlin
- **UI 框架**：Jetpack Compose + Material 3 Expressive
- **最低 SDK**：30（Android 11）
- **目标 SDK**：36
- **构建工具**：Gradle 8.13 + AGP 8.13.2

## 项目架构

项目采用分层架构设计，实现了清晰的职责分离：

```
app/src/main/java/com/github/lonepheasantwarrior/talkify/
├── MainActivity.kt                    # 应用入口
├── domain/                            # 领域层（业务逻辑核心）
│   ├── model/
│   │   ├── TtsModels.kt               # TTS 引擎和声音领域模型
│   │   ├── SynthesisParams.kt         # 语音合成参数模型
│   │   ├── EngineConfig.kt            # 引擎配置数据类（apiKey, voiceId）
│   │   ├── ConfigItem.kt              # 配置项数据类
│   │   ├── EngineIds.kt               # 引擎 ID 密封类（类型安全的引擎标识）
│   │   └── TtsEngineRegistry.kt       # 引擎注册表（单一数据源管理模式）
│   └── repository/
│       ├── VoiceRepository.kt         # 声音仓储接口
│       └── EngineConfigRepository.kt  # 引擎配置仓储接口
├── infrastructure/                    # 基础设施层（外部服务集成）
│   └── repository/
│       ├── Qwen3TtsVoiceRepository.kt       # 通义千问3语音仓储实现
│       └── Qwen3TtsConfigRepository.kt      # 通义千问3配置仓储实现（SharedPreferences）
└── ui/                                # 表现层（UI 组件）
    ├── components/
    │   ├── EngineSelector.kt          # 引擎切换控件
    │   ├── VoicePreview.kt            # 语音预览控件
    │   ├── ConfigEditor.kt            # 配置编辑表单
    │   └── ConfigBottomSheet.kt       # 底部设置弹窗
    ├── screens/
    │   └── MainScreen.kt              # 主界面
    └── theme/                         # 主题配置
        ├── Color.kt                   # 颜色定义
        ├── Theme.kt                   # 主题配置
        └── Type.kt                    # 字体排版
```

### 分层架构说明

**领域层（domain）** 包含核心业务模型和接口定义：
- `TtsEngine`：TTS 引擎数据类，包含引擎 ID、名称和提供商信息
- `Voice`：声音数据类，包含声音 ID、名称、性别和语言
- `SynthesisParams`：语音合成参数数据类
- `EngineConfig`：引擎配置数据类，包含 apiKey 和 voiceId
- `ConfigItem`：配置项数据类，支持密码模式和声音选择模式
- `EngineIds`：引擎 ID 密封类，提供类型安全的引擎标识定义
  - `Qwen3Tts`：阿里云通义千问3引擎（ID: qwen3-tts）
  - ID 直接采用云服务提供商的官方产品标识符
- `TtsEngineRegistry`：引擎注册表，单一数据源管理模式
  - `availableEngines`：获取所有可用引擎列表
  - `getEngine(id)`：根据 ID 获取引擎
  - `defaultEngine`：获取默认引擎
- `VoiceRepository`：声音仓储接口，定义获取声音列表的标准方法
- `EngineConfigRepository`：引擎配置仓储接口，定义配置存取方法

**基础设施层（infrastructure）** 负责外部服务集成和数据获取：
- `Qwen3TtsVoiceRepository`：通义千问3语音仓储实现，从资源文件加载声音列表
- `Qwen3TtsConfigRepository`：通义千问3配置仓储实现，使用 SharedPreferences 持久化
  - 按引擎 ID 隔离存储不同引擎的配置
  - 支持冷启动恢复已保存的配置

**表现层（ui）** 负责用户界面呈现和交互：
- `EngineSelector`：引擎切换组件，显示当前引擎并支持选择
- `VoicePreview`：语音预览组件，包含文本输入、声音选择和播放控制
- `ConfigEditor`：配置编辑表单，支持 API Key 输入和声音选择
- `ConfigBottomSheet`：底部设置弹窗，通过右下角悬浮按钮唤出
- `MainScreen`：主界面，整合所有组件实现完整功能

## 已实现功能

### 1. 引擎切换功能

- 显示当前选中的 TTS 引擎信息（名称和提供商）
- 点击弹出 Material 3 底部选择 Sheet
- 支持 SegmentedButton 风格的引擎选择
- 当前默认引擎：阿里云百炼"通义千问3语音合成"

### 2. 语音预览功能

**文本输入区域**：
- 多行文本输入框（3-5 行）
- 支持自定义标签和占位符

**声音选择区域**：
- 水平滚动列表展示可选声音
- 每个声音显示友好的中文名称（如"芊悦"、"苏瑶"等）
- 选中状态有视觉反馈（高亮背景）
- 支持 48 种阿里云通义千问3引擎的声音

**播放控制区域**：
- 长条形 Pill Button 样式
- 播放状态：绿色主题，显示"播放"文字和播放图标
- 停止状态：红色主题，显示"停止"文字和停止图标
- 图标和文字并排显示，不再残缺

### 3. 动态声音加载

- 使用 `LaunchedEffect` 监听引擎变化
- 根据当前引擎动态加载对应的声音列表
- 自动选中保存的配置中指定的声音或第一个可用声音
- 接口设计便于后续扩展其他引擎服务

### 4. 引擎配置编辑与存储

**配置编辑**：
- 右下角悬浮按钮（FloatingActionButton）唤出底部设置弹窗
- API Key 输入框（密码模式隐藏输入）
- 声音选择下拉菜单（从引擎可用声音列表中选择）
- 修改状态追踪，仅在有修改时启用保存按钮
- 保存后自动关闭设置弹窗

**配置存储**：
- 使用 Android 原生 SharedPreferences 持久化
- 每个引擎的配置独立存储（以引擎 ID 为前缀）
- 配置内容：apiKey（API 密钥）、voiceId（默认声音 ID）
- 支持冷启动恢复上次保存的配置
- 引擎选择独立存储，key 为 `selected_engine`

**引擎选择持久化**：
- 独立存储用户选择的引擎 ID（key: `selected_engine`）
- 应用启动时自动恢复上次选择的引擎
- 首次使用时保存默认引擎 ID
- 为后续系统级 TTS 服务调用提供基础

**交互优化**：
- 底部弹窗设计，比侧边抽屉更适合移动端
- 右下角悬浮按钮提供清晰的设置入口，符合从底部弹出的交互逻辑
- 点击外部区域或关闭按钮可关闭弹窗
- 保存成功后自动关闭，提供操作反馈

### 5. 引擎注册表

项目使用统一的引擎注册表管理所有可用引擎：

**引擎 ID 设计**：
- 直接采用云服务提供商的官方产品标识符
- 示例：`qwen3-tts`（阿里云通义千问3语音合成服务）
- 设计原则：便于 API 调用对接，减少映射转换

**注册表功能**：
- `TtsEngineRegistry.availableEngines`：获取所有可用引擎列表
- `TtsEngineRegistry.getEngine(id)`：根据 ID 获取引擎
- `TtsEngineRegistry.defaultEngine`：获取默认引擎
- `EngineIds.entries`：获取所有定义的引擎 ID

**新增引擎步骤**：
1. 在 `EngineIds` 密封类中添加新的引擎 ID 定义
2. 创建对应的 Repository 实现，命名规范：`{引擎名称}VoiceRepository`、`{引擎名称}ConfigRepository`
   - 示例：`Qwen3TtsVoiceRepository`、`Qwen4TtsVoiceRepository`（未来）
3. 在对应的 Repository 实现中添加引擎特定逻辑
4. 在 `MainScreen` 中注入对应的 Repository 实现
5. 注册表自动识别新引擎，无需额外配置

**命名规范**：
- 使用具体引擎名称作为类名前缀，避免使用云服务商公司名称
- 错误示例：`AlibabaCloudVoiceRepository`（公司名称，不够具体）
- 正确示例：`Qwen3TtsVoiceRepository`（引擎名称，清晰明确）

## 代码规范

### KDoc 注释标准

项目要求所有公开 API 和关键组件添加 KDoc 注释，确保代码自文档化：

**接口类注释**：
- 说明接口职责和用途
- 标注实现类信息
- 描述设计意图

**方法注释**：
- 说明方法功能
- 标注参数含义
- 描述返回值

**数据类注释**：
- 说明数据用途
- 标注字段含义
- 描述使用场景

**注释示例**：
```kotlin
/**
 * 引擎配置仓储接口
 *
 * 定义引擎配置存取的标准方法
 * 采用接口设计，解耦配置存储与业务逻辑
 * 支持多引擎配置隔离存储
 */
interface EngineConfigRepository {
    /**
     * 获取指定引擎的配置
     *
     * @param engine TTS 引擎
     * @return 引擎配置
     */
    fun getConfig(engine: TtsEngine): EngineConfig
}
```

## 资源文件

- `bailian-Qwen3-TTS-voices.xml`：阿里云百炼通义千问3引擎的声音配置
  - voice_ids：声音英文标识
  - display_names：中文显示名称
  - descriptions：声音特色描述
  - supported_languages：支持语言
  - supported_models：支持的模型版本

## 后续扩展计划

1. 接入阿里云 TTS API 实现实际语音合成功能
2. 添加更多云服务商支持（如讯飞、百度等）
3. 实现语音合成历史记录
4. 添加音频保存和分享功能
5. 支持离线语音合成引擎
6. 配置导入导出功能
